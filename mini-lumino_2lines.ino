#include <LEDMatrixDriver.hpp>

// This sketch draw marquee text on your LED matrix using the hardware SPI driver Library by Bartosz Bielawski.
// Example written 16.06.2017 by Marko Oette, www.oette.info 

// Define the ChipSelect pin for the led matrix (Dont use the SS or MISO pin of your Arduino!)
// Other pins are arduino specific SPI pins (MOSI=DIN of the LEDMatrix and CLK) see https://www.arduino.cc/en/Reference/SPI
const uint8_t LEDMATRIX_CS_PIN = 15;

// Define LED Matrix dimensions (0-n) - eg: 32x8 = 31x7
const int LEDMATRIX_WIDTH = 64;  
const int LEDMATRIX_HEIGHT = 7+8;
const int LEDMATRIX_SEGMENTS = 16;
const int LEDMATRIX_TOTAL_PIXEL = 64*16;

boolean bold = true;


// The LEDMatrixDriver class instance
LEDMatrixDriver lmd(LEDMATRIX_SEGMENTS, LEDMATRIX_CS_PIN);

void setup() {
  // init the display
  lmd.setEnabled(true);
  lmd.setIntensity(1);   // 0 = low, 10 = high
}

int x=0, y=0;   // start top left

// This is the font definition. You can use http://gurgleapps.com/tools/matrix to create your own font or sprites.
// If you like the font feel free to use it. I created it myself and donate it to the public domain.
byte font_regular[95][8] = { {0,0,0,0,0,0,0,0}, // SPACE
                     {0x10,0x18,0x18,0x18,0x18,0x00,0x18,0x18}, // EXCL
                     {0x28,0x28,0x08,0x00,0x00,0x00,0x00,0x00}, // QUOT
                     {0x00,0x0a,0x7f,0x14,0x28,0xfe,0x50,0x00}, // #
                     {0x10,0x38,0x54,0x70,0x1c,0x54,0x38,0x10}, // $
                     {0x00,0x60,0x66,0x08,0x10,0x66,0x06,0x00}, // %
                     {0,0,0,0,0,0,0,0}, // &
                     {0x00,0x10,0x18,0x18,0x08,0x00,0x00,0x00}, // '
                     {0x02,0x04,0x08,0x08,0x08,0x08,0x08,0x04}, // (
                     {0x40,0x20,0x10,0x10,0x10,0x10,0x10,0x20}, // )
                     {0x00,0x10,0x54,0x38,0x10,0x38,0x54,0x10}, // *
                     {0x00,0x08,0x08,0x08,0x7f,0x08,0x08,0x08}, // +
                     {0x00,0x00,0x00,0x00,0x00,0x18,0x18,0x08}, // COMMA
                     {0x00,0x00,0x00,0x00,0x7e,0x00,0x00,0x00}, // -
                     {0x00,0x00,0x00,0x00,0x00,0x00,0x06,0x06}, // DOT
                     {0x00,0x04,0x04,0x08,0x10,0x20,0x40,0x40}, // /
                     {0x00,0x38,0x44,0x4c,0x54,0x64,0x44,0x38}, // 0
                     {0x04,0x0c,0x14,0x24,0x04,0x04,0x04,0x04}, // 1
                     {0x00,0x30,0x48,0x04,0x04,0x38,0x40,0x7c}, // 2
                     {0x00,0x38,0x04,0x04,0x18,0x04,0x44,0x38}, // 3
                     {0x00,0x04,0x0c,0x14,0x24,0x7e,0x04,0x04}, // 4
                     {0x00,0x7c,0x40,0x40,0x78,0x04,0x04,0x38}, // 5
                     {0x00,0x38,0x40,0x40,0x78,0x44,0x44,0x38}, // 6
                     {0x00,0x7c,0x04,0x04,0x08,0x08,0x10,0x10}, // 7
                     {0x00,0x3c,0x44,0x44,0x38,0x44,0x44,0x78}, // 8
                     {0x00,0x38,0x44,0x44,0x3c,0x04,0x04,0x78}, // 9
                     {0x00,0x18,0x18,0x00,0x00,0x18,0x18,0x00}, // :
                     {0x00,0x18,0x18,0x00,0x00,0x18,0x18,0x08}, // ;
                     {0x00,0x10,0x20,0x40,0x80,0x40,0x20,0x10}, // <
                     {0x00,0x00,0x7e,0x00,0x00,0xfc,0x00,0x00}, // =
                     {0x00,0x08,0x04,0x02,0x01,0x02,0x04,0x08}, // >
                     {0x00,0x38,0x44,0x04,0x08,0x10,0x00,0x10}, // ?
                     {0x00,0x30,0x48,0xba,0xba,0x84,0x78,0x00}, // @
                     {0x00,0x1c,0x22,0x42,0x42,0x7e,0x42,0x42}, // A
                     {0x00,0x78,0x44,0x44,0x78,0x44,0x44,0x7c}, // B
                     {0x00,0x3c,0x44,0x40,0x40,0x40,0x44,0x7c}, // C
                     {0x00,0x7c,0x42,0x42,0x42,0x42,0x44,0x78}, // D
                     {0x00,0x7c,0x40,0x40,0x78,0x40,0x40,0x7c}, // E
                     {0x00,0x7c,0x40,0x40,0x78,0x40,0x40,0x40}, // F
                     {0x00,0x3c,0x40,0x40,0x5c,0x44,0x44,0x78}, // G
                     {0x00,0x42,0x42,0x42,0x7e,0x42,0x42,0x42}, // H
                     {0x00,0x7c,0x10,0x10,0x10,0x10,0x10,0x7e}, // I
                     {0x00,0x7e,0x02,0x02,0x02,0x02,0x04,0x38}, // J
                     {0x00,0x44,0x48,0x50,0x60,0x50,0x48,0x44}, // K
                     {0x00,0x40,0x40,0x40,0x40,0x40,0x40,0x7c}, // L
                     {0x00,0x82,0xc6,0xaa,0x92,0x82,0x82,0x82}, // M
                     {0x00,0x42,0x42,0x62,0x52,0x4a,0x46,0x42}, // N
                     {0x00,0x3c,0x42,0x42,0x42,0x42,0x44,0x38}, // O
                     {0x00,0x78,0x44,0x44,0x48,0x70,0x40,0x40}, // P
                     {0x00,0x3c,0x42,0x42,0x52,0x4a,0x44,0x3a}, // Q
                     {0x00,0x78,0x44,0x44,0x78,0x50,0x48,0x44}, // R
                     {0x00,0x3c,0x40,0x40,0x38,0x04,0x04,0x78}, // S
                     {0x00,0x7e,0x90,0x10,0x10,0x10,0x10,0x10}, // T
                     {0x00,0x42,0x42,0x42,0x42,0x42,0x42,0x3e}, // U
                     {0x00,0x42,0x42,0x42,0x42,0x44,0x28,0x10}, // V
                     {0x00,0x82,0x82,0x92,0x92,0x92,0x94,0x78}, // W
                     {0x00,0x42,0x42,0x24,0x18,0x24,0x42,0x42}, // X
                     {0x00,0x44,0x44,0x28,0x10,0x10,0x10,0x10}, // Y
                     {0x00,0x7c,0x04,0x08,0x7c,0x20,0x40,0xfe}, // Z
                     {0x00,0x66,0xff,0xff,0xff,0x7e,0x3c,0x18}, // <3
                      // (the font does not contain any lower case letters. you can add your own.)
                  };    // {}, //
  
  byte font_bold[95][8] = { {0,0,0,0,0,0,0,0}, // SPACE
                     {0x10,0x18,0x18,0x18,0x18,0x00,0x18,0x18}, // EXCL
                     {0x28,0x28,0x08,0x00,0x00,0x00,0x00,0x00}, // QUOT
                     {0x00,0x0a,0x7f,0x14,0x28,0xfe,0x50,0x00}, // #
                     {0x10,0x38,0x54,0x70,0x1c,0x54,0x38,0x10}, // $
                     {0x00,0x60,0x66,0x08,0x10,0x66,0x06,0x00}, // %
                     {0,0,0,0,0,0,0,0}, // &
                     {0x00,0x10,0x18,0x18,0x08,0x00,0x00,0x00}, // '
                     {0x02,0x04,0x08,0x08,0x08,0x08,0x08,0x04}, // (
                     {0x40,0x20,0x10,0x10,0x10,0x10,0x10,0x20}, // )
                     {0x00,0x10,0x54,0x38,0x10,0x38,0x54,0x10}, // *
                     {0x00,0x08,0x08,0x08,0x7f,0x08,0x08,0x08}, // +
                     {0x00,0x00,0x00,0x00,0x00,0x18,0x18,0x08}, // COMMA
                     {0x00,0x00,0x00,0x00,0x7e,0x00,0x00,0x00}, // -
                     {0x00,0x00,0x00,0x00,0x00,0x00,0x06,0x06}, // DOT
                     {0x00,0x04,0x04,0x08,0x10,0x20,0x40,0x40}, // /
                     {0x00,0x38,0x44,0x4c,0x54,0x64,0x44,0x38}, // 0
                     {0x04,0x0c,0x14,0x24,0x04,0x04,0x04,0x04}, // 1
                     {0x00,0x30,0x48,0x04,0x04,0x38,0x40,0x7c}, // 2
                     {0x00,0x38,0x04,0x04,0x18,0x04,0x44,0x38}, // 3
                     {0x00,0x04,0x0c,0x14,0x24,0x7e,0x04,0x04}, // 4
                     {0x00,0x7c,0x40,0x40,0x78,0x04,0x04,0x38}, // 5
                     {0x00,0x38,0x40,0x40,0x78,0x44,0x44,0x38}, // 6
                     {0x00,0x7c,0x04,0x04,0x08,0x08,0x10,0x10}, // 7
                     {0x00,0x3c,0x44,0x44,0x38,0x44,0x44,0x78}, // 8
                     {0x00,0x38,0x44,0x44,0x3c,0x04,0x04,0x78}, // 9
                     {0x00,0x18,0x18,0x00,0x00,0x18,0x18,0x00}, // :
                     {0x00,0x18,0x18,0x00,0x00,0x18,0x18,0x08}, // ;
                     {0x00,0x10,0x20,0x40,0x80,0x40,0x20,0x10}, // <
                     {0x00,0x00,0x7e,0x00,0x00,0xfc,0x00,0x00}, // =
                     {0x00,0x08,0x04,0x02,0x01,0x02,0x04,0x08}, // >
                     {0x00,0x38,0x44,0x04,0x08,0x10,0x00,0x10}, // ?
                     {0x00,0x30,0x48,0xba,0xba,0x84,0x78,0x00}, // @
                     {0x3c,0x7e,0x66,0x66,0x7e,0x7e,0x66,0x66}, //A
                     {0x7c,0x7e,0x66,0x7c,0x7c,0x66,0x7e,0x7c}, //B
                     {0x3e,0x7e,0x60,0x60,0x60,0x60,0x7e,0x3e}, //C
                     {0x7c,0x7e,0x66,0x66,0x66,0x66,0x7e,0x7c}, //D
                     {0x7e,0x7e,0x60,0x7c,0x7c,0x60,0x7e,0x7e}, //E
                     {0x7e,0x7e,0x60,0x7c,0x7c,0x60,0x60,0x60}, //F
                     {0x7e,0x7e,0x60,0x6e,0x6e,0x66,0x7e,0x7e}, //G
                     {0x66,0x66,0x66,0x7e,0x7e,0x66,0x66,0x66}, //H
                     {0x7e,0x7e,0x18,0x18,0x18,0x18,0x7e,0x7e}, //I
                     {0x7e,0x7e,0x06,0x06,0x06,0x06,0x7e,0x7c}, //J
                     {0x66,0x6e,0x7c,0x78,0x78,0x7c,0x6e,0x66}, //K
                     {0x60,0x60,0x60,0x60,0x60,0x60,0x7e,0x7e}, //L
                     {0xc6,0xee,0xfe,0xd6,0xc6,0xc6,0xc6,0xc6}, //M
                     {0x66,0x66,0x76,0x7e,0x7e,0x6e,0x66,0x66}, //N
                     {0x3c,0x7e,0x66,0x66,0x66,0x66,0x7e,0x3c}, //O
                     {0x78,0x7c,0x66,0x66,0x7c,0x78,0x60,0x60}, //P
                     {0x3c,0x7e,0x66,0x66,0x66,0x6e,0x7c,0x3a}, //Q
                     {0x7c,0x7e,0x66,0x66,0x7c,0x7c,0x6e,0x66}, //R
                     {0x3e,0x7e,0x60,0x7c,0x3e,0x06,0x7e,0x7c}, //S
                     {0x00,0x7e,0x7e,0x18,0x18,0x18,0x18,0x18}, //T
                     {0x66,0x66,0x66,0x66,0x66,0x66,0x7e,0x3c}, //U
                     {0x66,0x66,0x66,0x66,0x66,0x66,0x3c,0x18}, //V
                     {0xc3,0xc3,0xc3,0xdb,0xdb,0xdb,0xff,0x7e}, //W
                     {0x42,0x66,0x66,0x3c,0x3c,0x66,0x66,0x42}, //X
                     {0x66,0x66,0x66,0x3c,0x18,0x18,0x18,0x18}, //Y
                     {0x7e,0x7e,0x06,0x1c,0x38,0x60,0x7e,0x7e}, //Z
                     {0x00,0x66,0xff,0xff,0xff,0x7e,0x3c,0x18}, // <3
                      // (the font does not contain any lower case letters. you can add your own.)
                  };

// Marquee speed
const int ANIM_DELAY = 100;

// Marquee text 
//char[] = "** LED MATRIX DEMO! ** (1234567890) ++ \"ABCDEFGHIJKLMNOPQRSTUVWXYZ\" ++ <$%/=?'.@,> --";
char* text = "";


void loop() 
{
 // Draw the text to the current position
  int len = 0;


  text = "[ SUSE [";
  len = strlen(text);
  drawLine(text, len, 0, 1);


  text = "[[[[[[[[";
  len = strlen(text);
  drawLine(text, len, 1, 1);


  /*
  text = " I[SUSE";
  len = strlen(text);
  drawLine(text, len, 1);
*/



   // In case you wonder why we don't have to call lmd.clear() in every loop: The font has a opaque (black) background...
  // setPixel(63,8,1);
   //lmd.setPixel(64,0,1);
   

 // Toggle display of the new framebuffer
 lmd.display();
 // set_All();
 // randomize(0);
 // Wait to let the human read the display
 delay(ANIM_DELAY);

 // Advance to next coordinate
 //if( --x < len * -8 )
 //  x = LEDMATRIX_WIDTH;
}

void clear_All(){
  for(int i=0;i<128;i++){
    for(int j=0;j<8;j++){
      lmd.setPixel(i, j, 0);
    }
  }
  lmd.display();
}

void set_All(){
  for(int i=0;i<128;i++){
    for(int j=0;j<8;j++){
      lmd.setPixel(i, j, 1);
    }
  }
  lmd.display();
}

void randomize(int state) {
  for (int i = 0; i<=LEDMATRIX_TOTAL_PIXEL; i++) {
    int y_pixel = rand() % 8;
    int x_pixel = rand() % 128;
    lmd.setPixel(x_pixel, y_pixel, state);
    lmd.display();

  }
}

void setPixel(int x, int y, bool value) {
  int real_x = 0;
  int real_y = 0;
  //real_x = (((int)(y/8))*64)+x;
  //real_y = y - (((int)(y/8))*8);

  if (y < 8) {
    real_x = x;
    real_y = y;
  } else {
    real_x = 64 + x;
    real_y = y - 8;
  }
  lmd.setPixel(real_x, real_y, value);
}

void drawLine(char* text, int len, int line, boolean bold) {

  drawString(text, len, 0, 8*line, bold);
}

/**
 * This function draws a string of the given length to the given position.
 */
void drawString(char* text, int len, int x, int y, boolean bold )
{
 // byte *font[95] = bold ? &font_bold : &font_regular;
  for( int idx = 0; idx < len; idx ++ )
  {
    int c = text[idx] - 32;

    // stop if char is outside visible area
    if( x + idx * 8  > LEDMATRIX_WIDTH-1 )
      return;
    
    // only draw if char is visible
    if( 8 + x + idx * 8 > 0 ) {
      if (bold) {
        drawSprite( font_bold[c], x + idx * 8, y, 8, 8 );
      }
     else {
        drawSprite( font_regular[c], x + idx * 8, y, 8, 8 );
      }
    }
      
  }
}

/**
 * This draws a sprite to the given position using the width and height supplied (usually 8x8)
 */
void drawSprite( byte* sprite, int x, int y, int width, int height )
{
  // The mask is used to get the column bit from the sprite row
  byte mask = B10000000;
  
  for( int iy = 0; iy < height; iy++ )
  {
    for( int ix = 0; ix < width; ix++ )
    {
      setPixel(x + ix, y + iy, (bool)(sprite[iy] & mask ));

      // shift the mask by one pixel to the right
      mask = mask >> 1;
    }

    // reset column mask
    mask = B10000000;
  }
}


